# Taichi AOT Demo: Implicit FEM

<img width=35% src=https://github.com/taichi-dev/taichi/releases/download/v1.0.0/taichi-aot-demo.gif>

This repo includes Taichi AOT demo for implicit FEM.

```
python/  # Taichi python script for implicit_fem
desktop/  # desktop demo
android/  # android demo
  app/
    src/
      main/
        assets/
          shaders/
            aot/  # generated by `python implicit_fem.py --aot` in python/
            render/  # shaders used in rendering
```

## Desktop Demo
Taichi built with

```
python setup.py clean && TAICHI_CMAKE_ARGS="-DTI_WITH_VULKAN:BOOL=ON -DTI_WITH_CUDA:BOOL=OFF -DTI_WITH_OPENGL:BOOL=OFF -DTI_WITH_LLVM:BOOL=OFF -DTI_EXPORT_CORE:BOOL=ON" python3 setup.py build_ext
```
Upon successful completion, the build artifacts should be located at `_skbuild/*/cmake-install` within the taichi directory. Then, provide this path to CMake as 

```
cd desktop
mkdir build && cd build
cmake -DCMAKE_PREFIX_PATH=/path_github_taichi/_skbuild/your_system_version/cmake-install ..
make
```

## Android Demo
If you are building Taichi with custom changes, make sure to copy the prebuilt `libtaichi_export_core.so` to: `app/src/main/jniLibs/arm64-v8a/`
```
export TAICHI_REPO_DIR=/path/github/taichi/
export ANDROID_SDK_ROOT=/path/to/Andriod/Sdk
cd android
ln -s ${TAICHI_REPO_DIR}/_skbuild/linux-x86_64-3.8/cmake-build/libtaichi_export_core.so app/src/main/jniLibs/arm64-v8a/
./gradlew assembleDebug
adb install ./app/build/outputs/apk/debug/app-debug.apk
```

Taichi built with
```
export ANDROID_NDK_ROOT="<path_to_android_ndk>"  # e.g. ~/Android/Sdk/ndk/22.1.7171670/
python setup.py clean && TAICHI_CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake -DANDROID_NATIVE_API_LEVEL=29 -DANDROID_ABI=arm64-v8a" python3 setup.py build_ext
```

## Troubleshooting

- Note that if you built for the desktop demo first and then decide to cross-compile to android, the manual cleanup (`python setup.py clean`) is required. CMake cannot automatically adjust build directory from one build type to another. More details can be found at [this stackoverflow question](https://stackoverflow.com/questions/40528254/how-do-i-detect-that-i-am-cross-compiling-in-cmakelists-txt).

- Monitor Android logs

```
adb logcat -s "TaichiTest" "*:F" "AndroidRuntime" vulkan taichi VALIDATION
```
